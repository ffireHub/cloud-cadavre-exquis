---
- name: Install KubernetesADM
  hosts: all
  become: true
  tasks:
      - name: Install docker
        ansible.builtin.dnf:
            name: docker
            state: present
            update_cache: true
        tags: install

      - name: Start and enable docker
        ansible.builtin.service:
            name: docker
            state: started
            enabled: true
        tags: install

      - name: Install apt-transport-https
        ansible.builtin.dnf:
            name: apt-transport-https
            state: present
        tags: install

      - name: Add Kubernetes apt repository
        ansible.builtin.yum_repository:
            name: kubernetes
            description: Kubernetes Repository
            baseurl: https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch
            gpgcheck: true
            gpgkey: https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
            enabled: true
            state: present
        tags: install

      - name: Install kubelet kubeadm kubectl
        ansible.builtin.dnf:
            name: '{{ packages }}'
            state: present
            update_cache: true
        tags: install
        vars:
            packages:
                - kubelet
                - kubeadm
                - kubectl

- name: Setup Kubernetes controller
  hosts: controller
  become: true
  tasks:
      - name: Pull kubeadm required images
        ansible.builtin.command: kubeadm config images pull
        tags: setup_controller

      - name: Initialize Kubernetes master
        ansible.builtin.command: kubeadm init --pod-network-cidr=10.244.0.0/16
        tags: setup_controller

      - name: Copy kube config file for regular user
        ansible.builtin.copy:
            src: /etc/kubernetes/admin.conf
            dest: $HOME/.kube/config_remote
            owner: '{{ ansible_user }}'
            group: '{{ ansible_user }}'
            mode: '0644'
        tags: setup_controller

      - name: Get join command
        ansible.builtin.shell: kubeadm token create --print-join-command
        register: k8s_join_command
        changed_when: false
        tags: setup_controller

      - name: Get Master IP
        ansible.builtin.shell: hostname -I | awk '{print $1}'
        register: k8s_master_ip
        changed_when: false
        tags: setup_controller

- name: Setup Kubernetes worker
  hosts: workers
  become: true
  tasks:
      - name: Join cluster
        ansible.builtin.shell: '{{ hostvars[k8s-controller].k8s_join_command.stdout }}'
        tags: setup_worker
