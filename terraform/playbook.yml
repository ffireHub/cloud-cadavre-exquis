---
- name: Install KubernetesADM
  hosts: all
  become: true
  tasks:
      - name: Install docker
        ansible.builtin.dnf:
            name: docker
            state: present
            update_cache: true
        tags: install

      - name: Start and enable docker
        ansible.builtin.service:
            name: docker
            state: started
            enabled: true
        tags: install

      - name: Install apt-transport-https
        ansible.builtin.dnf:
            name: apt-transport-https
            state: present
        tags: install

      - name: Add Kubernetes apt repository
        ansible.builtin.yum_repository:
            name: kubernetes
            description: Kubernetes Repository
            baseurl: https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch
            gpgcheck: true
            gpgkey: https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
            enabled: true
            state: present
        tags: install

      - name: Install kubelet kubeadm kubectl
        ansible.builtin.dnf:
            name: '{{ packages }}'
            state: present
            update_cache: true
        tags: install
        vars:
            packages:
                - kubelet
                - kubeadm
                - kubectl
                - iproute-tc
      - name: Enable and start kubelet
        ansible.builtin.service:
            name: kubelet
            state: started
            enabled: true
        tags: install
      - name: Remove swap package
        ansible.builtin.dnf:
            name: zram-generator-defaults
            state: absent
        tags: install
      - name: Disable swap
        ansible.builtin.shell: sudo swapoff -a
        tags: install
      - name: Restart containerd
        ansible.builtin.service:
            name: containerd
            state: restarted
            enabled: true
        tags: install

- name: Setup Kubernetes controller
  hosts: controller
  become: true
  tasks:
            - name: Pull kubeadm required images
              ansible.builtin.command: sudo kubeadm config images pull
              tags: setup_controller
            - name: Initialize Kubernetes master
              ansible.builtin.command: sudo kubeadm init --pod-network-cidr=10.244.0.0/16
              tags: setup_controller
            - name: Create directory for kube config
              ansible.builtin.file:
                  path: /home/fedora/.kube
                  state: directory
                  owner: 'fedora'
                  group: 'fedora'
                  mode: '0644'
            - name: Copy kube config file for regular user
              ansible.builtin.copy:
                  src: /etc/kubernetes/admin.conf
                  dest: /home/fedora/.kube/config_remote
                  owner: 'fedora'
                  group: 'fedora'
                  mode: '0644'
                  remote_src: true
              tags: setup_controller

            - name: Get join command
              ansible.builtin.command: sudo kubeadm token create --print-join-command
              register: join_command_raw
              changed_when: false
              tags: setup_controller

            - name: Set join command
              ansible.builtin.set_fact: join_command:"{{ join_command_raw.stdout_lines[0] }}"

            - name: Get Master IP
              ansible.builtin.command: hostname -I | awk '{print $1}'
              register: k8s_master_ip
              changed_when: false
              tags: setup_controller

- hosts: workers
  become: true
  tasks:
      - name: Print join command
        ansible.builtin.debug:
            msg: "{{ hostvars['controller'].join_command }}"
      - name: Join cluster
        ansible.builtin.shell: "{{ hostvars['controller'].join_command }}"
        tags: setup_worker
